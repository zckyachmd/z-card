services:
  web:
    container_name: z-card
    build:
      context: .
      target: runner
    # Environment variables
    # IMPORTANT: Environment variables set in Portainer UI will be available to the container
    # Portainer passes env vars to Docker, which are then available in process.env
    #
    # Required env vars (set these in Portainer):
    #   - SMTP_HOST, SMTP_PORT, SMTP_FROM_EMAIL, SMTP_TO_EMAIL
    #   - SMTP_USER, SMTP_PASS (if SMTP requires authentication)
    #   - CLOUDFLARE_TURNSTILE_SECRET_KEY
    #   - NEXT_PUBLIC_CLOUDFLARE_TURNSTILE_SITE_KEY (for client-side)
    #
    # Optional env vars:
    #   - SMTP_SECURE (true/false, default: false)
    #   - RATE_LIMIT_MAX_REQUESTS (default: 5)
    #   - RATE_LIMIT_WINDOW_MS (default: 60000)
    #   - UMAMI_URL (e.g. https://umami.example.com)
    #   - UMAMI_WEBSITE_ID
    #   - UMAMI_SCRIPT_PATH (default: /script.js)
    #   - UMAMI_DOMAINS (comma-separated)
    #   - UMAMI_AUTO_TRACK (true/false, default: true)
    #   - DEBUG_ENV (set to "true" to see env vars in logs)
    env_file:
      - .env
    environment:
      NODE_ENV: production
      NEXT_TELEMETRY_DISABLED: "1"
      PORT: "3000"
      HOSTNAME: "0.0.0.0"
    ports:
      - "3000:3000"
    restart: unless-stopped

    # Security: Resource limits to prevent DoS
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 256M

    # Security: Read-only root filesystem with tmpfs for writable areas
    # Note: Next.js standalone mode should work with read-only filesystem
    # If you encounter write errors, you may need to add more tmpfs mounts
    # or disable read_only mode
    read_only: true
    tmpfs:
      - /tmp
      - /var/tmp
      # Uncomment if Next.js needs cache directory
      # - /app/.next/cache:rw,noexec,nosuid,size=100m

    # Security: Disable privilege escalation
    security_opt:
      - no-new-privileges:true

    # Security: Drop all capabilities and only add what's needed
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE  # Required to bind to port 3000

    # Security: Use specific user (non-root)
    user: "1001:1001"

    # Health check using curl (now available in image)
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

    # Security: Network isolation
    networks:
      - z-card-network

networks:
  z-card-network:
    driver: bridge
    internal: false  # Set to true if you don't need external internet access
